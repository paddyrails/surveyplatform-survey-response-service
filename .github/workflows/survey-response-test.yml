name: 'Survey Response: Test APIs'

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        default: 'dev'
        type: choice
        options: [dev, staging, prod]

env:
  SERVICE_NAME: survey-response-service
  RESOURCE_GROUP: rg-surveyplatform-${{ github.event.inputs.environment }}
  NAMESPACE: survey-platform

jobs:
  test:
    name: Test APIs
    runs-on: ubuntu-latest
    steps:
      - uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      - run: |
          AKS=$(az aks list -g ${{ env.RESOURCE_GROUP }} --query '[0].name' -o tsv)
          az aks get-credentials -g ${{ env.RESOURCE_GROUP }} -n $AKS --overwrite-existing
      - uses: azure/setup-kubectl@v4
      - name: Test
        run: |
          IP=$(kubectl get svc ingress-nginx-controller -n ingress-nginx -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          BASE="http://$IP/api/responses"
          echo "## Survey Response API Tests" >> $GITHUB_STEP_SUMMARY
          H=$(curl -s -o /dev/null -w "%{http_code}" "$BASE/health" || echo "000")
          [ "$H" == "200" ] && echo "✅ Health: $H" >> $GITHUB_STEP_SUMMARY || echo "❌ Health: $H" >> $GITHUB_STEP_SUMMARY
          G=$(curl -s -o /dev/null -w "%{http_code}" "$BASE" || echo "000")
          echo "- GET /api/responses: $G" >> $GITHUB_STEP_SUMMARY
